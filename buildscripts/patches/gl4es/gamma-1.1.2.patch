From a66be40520e57f7ef3016ff03a0df4382e9d55b7 Mon Sep 17 00:00:00 2001
From: Dmitry <docent27@ukr.net>
Date: Sun, 11 Jul 2021 15:55:39 +0300
Subject: [PATCH] gamma-patch-1.1.2

---
 src/gl/fpe.h        | 1 +
 src/gl/fpe_shader.c | 5 ++++-
 src/gl/light.c      | 4 ++++
 3 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/src/gl/fpe.h b/src/gl/fpe.h
index 4480bfd..309aa4c 100755
--- a/src/gl/fpe.h
+++ b/src/gl/fpe.h
@@ -150,6 +150,7 @@ typedef struct fpe_state_s {
     unsigned int pointsprite:1;          // point sprite rendering
     unsigned int pointsprite_coord:1;    // point sprite coord replace
     unsigned int pointsprite_upper:1;    // if coord is upper left and not lower left
+    int16_t gamma;
 }__attribute__((packed)) fpe_state_t;
 
 typedef struct fpe_fpe_s {
diff --git a/src/gl/fpe_shader.c b/src/gl/fpe_shader.c
index d3c983f..506fbcb 100755
--- a/src/gl/fpe_shader.c
+++ b/src/gl/fpe_shader.c
@@ -1205,7 +1205,10 @@ const char* const* fpe_FragmentShader(fpe_state_t *state) {
         }
         ShadAppend("fColor.rgb = mix(gl_Fog.color.rgb, fColor.rgb, FogF);\n");
     }
-
+    if (state->gamma) {
+        sprintf(buff, "fColor.rgb = pow(fColor.rgb, vec3(1.0 / %.3f));\n", state->gamma / 100.0);
+        ShadAppend(buff);
+    }
     //done
     ShadAppend("gl_FragColor = fColor;\n");
     ShadAppend("}");
diff --git a/src/gl/light.c b/src/gl/light.c
index 54aeb4f..1f114a9 100755
--- a/src/gl/light.c
+++ b/src/gl/light.c
@@ -77,6 +77,10 @@ void gl4es_glLightModelfv(GLenum pname, const GLfloat* params) {
             return;
         } else gl4es_flush();
     switch (pname) {
+        case 0x4242:
+            if (glstate->fpe_state)
+                glstate->fpe_state->gamma = params[0] * 100;
+            return;
         case GL_LIGHT_MODEL_AMBIENT:
             if(memcmp(glstate->light.ambient, params, 4*sizeof(GLfloat))==0) {
                 noerrorShim();
--
libgit2 0.28.4

